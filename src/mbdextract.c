/*
 * mbdextract.c: extract game scripts from MBD files.
 *
 * Copyright (c) 2014 Yishen Miao
 *
 * This file is part of MBDextract
 *
 * MBDextract is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 2 of the License, or
 * (at your option) any later version.
 *
 * MBDextract is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with MBDextract.  If not, see <http://www.gnu.org/licenses/>.
 *
 */

#include <config.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <errno.h>

const char *ver_str = PACKAGE_STRING;
const char *bugreport = PACKAGE_BUGREPORT;

void printUsage(char pname[])
{
	printf("%s\nUsage: %s file\n\nplease send bug reports to <%s>.\n", 
			ver_str, pname, bugreport);
}


int main(int argc, char *argv[])
{
	FILE *ifp;
	const char *mode = "rb";
	char *fbuff, *mbdp, *p, *tmp[8];
	unsigned long ifp_len;
	int i;
	unsigned long offset;

	const char magicnum[] = {0x4d, 0x42, 0x44, 0x00};
	
/*
 * The conversation talbe comes from 
 * http://forums.qhimm.com/index.php?topic=8163.msg98625#msg98625
 *
 * sdict and shash contains:
 * 
 * 4-byte control strings
 *  
 * 4-byte symbles: 
 * 0x80000000 - 0x80001900 are capital case letters.
 * 0x80002000 - 0x80003300 are lower case letters.
 * 0x80003400 - 0x80003D00 are digits.
 * 0x80003E00 - 0x80005A00 are symbols.
 * 
 * ldict and lhash contains:
 * 
 * 8-byte control strings
 */
	
	const char *ldict[] = {
		"<1TEXT>","<2TEXT>","<3TEXT>","<4TEXT>",
		"<5TEXT>","<6TEXT>","<7TEXT>","<8TEXT>",
		"<9TEXT>","<10TEXT>","<11TEXT>","<12TEXT>",
		"<13TEXT>","<14TEXT>","<15TEXT>","<16TEXT>",
		"<17TEXT>","<18TEXT>","<19TEXT>","<20TEXT>",
		"<21TEXT>","<22TEXT>","<23TEXT>","<24TEXT>",
		"<25TEXT>","<26TEXT>","<27TEXT>","<28TEXT>",
		"<29TEXT>","<30TEXT>","<31TEXT>","<32TEXT>",
		"<33TEXT>","<34TEXT>","<35TEXT>","<36TEXT>",
		"<37TEXT>","<38TEXT>","<39TEXT>","<40TEXT>",
		"<41TEXT>","<42TEXT>","<43TEXT>","<44TEXT>",
		"<45TEXT>","<46TEXT>","<47TEXT>","<48TEXT>",
		"<49TEXT>","<50TEXT>","<51TEXT>","<52TEXT>",
		"<53TEXT>","<54TEXT>","<55TEXT>","<56TEXT>",
		"<57TEXT>","<58TEXT>","<59TEXT>","<60TEXT>",
		"<61TEXT>","<62TEXT>","<63TEXT>","<64TEXT>",
		"<65TEXT>","<66TEXT>","<67TEXT>","<68TEXT>",
		"<69TEXT>","<70TEXT>","<71TEXT>","<72TEXT>",
		"<73TEXT>","<74TEXT>","<75TEXT>","<76TEXT>",
		"<77TEXT>","<78TEXT>","<79TEXT>","<80TEXT>",
		"<81TEXT>","<82TEXT>","<83TEXT>","<84TEXT>",
		"<85TEXT>","<86TEXT>","<87TEXT>","<88TEXT>",
		"<89TEXT>","<90TEXT>","<91TEXT>","<92TEXT>",
		"<93TEXT>","<94TEXT>","<95TEXT>","<96TEXT>",
		"<97TEXT>","<98TEXT>","<99TEXT>","<100TEXT>",
		"<101TEXT>","<102TEXT>","<103TEXT>","<104TEXT>",
		"<105TEXT>","<106TEXT>","<107TEXT>","<108TEXT>",
		"<109TEXT>","<110TEXT>","<111TEXT>","<112TEXT>",
		"<113TEXT>","<114TEXT>","<115TEXT>","<116TEXT>",
		"<117TEXT>","<118TEXT>","<119TEXT>","<120TEXT>",
		"<121TEXT>","<122TEXT>","<123TEXT>","<124TEXT>",
		"<125TEXT>","<126TEXT>","<127TEXT>","<128TEXT>",
		"<129TEXT>","<130TEXT>","<131TEXT>","<132TEXT>",
		"<133TEXT>","<134TEXT>","<135TEXT>","<136TEXT>",
		"<137TEXT>","<138TEXT>","<139TEXT>","<140TEXT>",
		"<141TEXT>","<142TEXT>","<143TEXT>","<144TEXT>",
		"<145TEXT>","<146TEXT>","<147TEXT>","<148TEXT>",
		"<149TEXT>","<150TEXT>","<151TEXT>","<152TEXT>",
		"<153TEXT>","<154TEXT>","<155TEXT>","<156TEXT>",
		"<157TEXT>","<158TEXT>","<159TEXT>","<160TEXT>",
		"<161TEXT>","<162TEXT>","<163TEXT>","<164TEXT>",
		"<165TEXT>","<166TEXT>","<167TEXT>","<168TEXT>",
		"<169TEXT>","<170TEXT>","<171TEXT>","<172TEXT>",
		"<173TEXT>","<174TEXT>","<175TEXT>","<176TEXT>",
		"<177TEXT>","<178TEXT>","<179TEXT>","<180TEXT>",
		"<181TEXT>","<182TEXT>","<183TEXT>","<184TEXT>",
		"<185TEXT>","<186TEXT>","<187TEXT>","<188TEXT>",
		"<189TEXT>","<190TEXT>","<191TEXT>","<192TEXT>",
		"<193TEXT>","<194TEXT>","<195TEXT>","<196TEXT>",
		"<197TEXT>","<198TEXT>","<199TEXT>","<200TEXT>",
		"<201TEXT>","<202TEXT>","<203TEXT>","<204TEXT>",
		"<205TEXT>","<206TEXT>","<207TEXT>","<208TEXT>",
		"<209TEXT>","<210TEXT>","<211TEXT>","<212TEXT>",
		"<213TEXT>","<214TEXT>","<215TEXT>","<216TEXT>",
		"<217TEXT>","<218TEXT>","<219TEXT>","<220TEXT>",
		"<221TEXT>","<222TEXT>","<223TEXT>","<224TEXT>",
		"<225TEXT>","<226TEXT>","<227TEXT>","<228TEXT>",
		"<229TEXT>","<230TEXT>","<231TEXT>","<232TEXT>",
		"<233TEXT>","<234TEXT>","<235TEXT>","<236TEXT>",
		"<237TEXT>","<238TEXT>","<239TEXT>","<240TEXT>",
		"<241TEXT>","<242TEXT>","<243TEXT>","<244TEXT>",
		"<245TEXT>","<246TEXT>","<247TEXT>","<248TEXT>",
		"<249TEXT>","<250TEXT>","<251TEXT>","<252TEXT>",
		"<253TEXT>","<254TEXT>","<255TEXT>","<256TEXT>"
	};
	
	const char lhash[] = {
		0x00, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0x01, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0x02, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0x03, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0x04, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0x05, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0x06, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0x07, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0x08, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0x09, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0x0a, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0x0b, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0x0c, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0x0d, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0x0e, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0x0f, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0x10, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0x11, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0x12, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0x13, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0x14, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0x15, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0x16, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0x17, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0x18, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0x19, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0x1a, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0x1b, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0x1c, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0x1d, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0x1e, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0x1f, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0x20, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0x21, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0x22, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0x23, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0x24, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0x25, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0x26, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0x27, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0x28, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0x29, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0x2a, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0x2b, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0x2c, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0x2d, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0x2e, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0x2f, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0x30, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0x31, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0x32, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0x33, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0x34, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0x35, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0x36, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0x37, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0x38, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0x39, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0x3a, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0x3b, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0x3c, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0x3d, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0x3e, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0x3f, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0x40, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0x41, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0x42, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0x43, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0x44, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0x45, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0x46, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0x47, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0x48, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0x49, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0x4a, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0x4b, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0x4c, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0x4d, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0x4e, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0x4f, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0x50, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0x51, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0x52, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0x53, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0x54, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0x55, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0x56, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0x57, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0x58, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0x59, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0x5a, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0x5b, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0x5c, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0x5d, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0x5e, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0x5f, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0x60, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0x61, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0x62, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0x63, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0x64, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0x65, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0x66, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0x67, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0x68, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0x69, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0x6a, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0x6b, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0x6c, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0x6d, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0x6e, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0x6f, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0x70, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0x71, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0x72, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0x73, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0x74, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0x75, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0x76, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0x77, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0x78, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0x79, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0x7a, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0x7b, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0x7c, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0x7d, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0x7e, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0x7f, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0x80, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0x81, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0x82, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0x83, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0x84, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0x85, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0x86, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0x87, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0x88, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0x89, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0x8a, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0x8b, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0x8c, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0x8d, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0x8e, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0x8f, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0x90, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0x91, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0x92, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0x93, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0x94, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0x95, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0x96, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0x97, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0x98, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0x99, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0x9a, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0x9b, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0x9c, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0x9d, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0x9e, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0x9f, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0xa0, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0xa1, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0xa2, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0xa3, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0xa4, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0xa5, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0xa6, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0xa7, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0xa8, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0xa9, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0xaa, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0xab, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0xac, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0xad, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0xae, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0xaf, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0xb0, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0xb1, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0xb2, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0xb3, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0xb4, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0xb5, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0xb6, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0xb7, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0xb8, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0xb9, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0xba, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0xbb, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0xbc, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0xbd, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0xbe, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0xbf, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0xc0, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0xc1, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0xc2, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0xc3, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0xc4, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0xc5, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0xc6, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0xc7, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0xc8, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0xc9, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0xca, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0xcb, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0xcc, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0xcd, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0xce, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0xcf, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0xd0, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0xd1, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0xd2, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0xd3, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0xd4, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0xd5, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0xd6, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0xd7, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0xd8, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0xd9, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0xda, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0xdb, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0xdc, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0xdd, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0xde, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0xdf, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0xe0, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0xe1, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0xe2, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0xe3, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0xe4, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0xe5, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0xe6, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0xe7, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0xe8, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0xe9, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0xea, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0xeb, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0xec, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0xed, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0xee, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0xef, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0xf0, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0xf1, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0xf2, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0xf3, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0xf4, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0xf5, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0xf6, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0xf7, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0xf8, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0xf9, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0xfa, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0xfb, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0xfc, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0xfd, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0xfe, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
		0xff, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00
	};

	const char *sdict[] = {
		"<???TEXT>", 
		"<STRING>\n", 
		"<NL>\n", 
		"<UNK1>", 
		"<END>\n\n", 
		"<M-CHOICE1>", 
		"<M-CHIOCE2>", 
		"<M-CHOICE3>", 
		"<M-CHOICE4>", 
		"<M-CHOICE5>", 
		"<M-CHOICE6>", 
		"<M-CHOICE7>", 
		"<M-CHOICE8>", 
		"<CROSS-PAD>", 
		"<CROSS-SQUARE>", 
		"<VAR1>", 
		"<VAR2>", 
		"<VAR3>", 
		"<VAR4>", 
		"<VAR5>", 
		"<MDB>", 
		"<CHOICE1>", 
		"<CHOICE2>", 
		"<FUNCTION1>", 
		"A", 
		"B", 
		"C", 
		"D", 
		"E", 
		"F", 
		"G", 
		"H", 
		"I", 
		"J", 
		"K", 
		"L", 
		"M", 
		"N", 
		"O", 
		"P", 
		"Q", 
		"R", 
		"S", 
		"T", 
		"U", 
		"V", 
		"W", 
		"X", 
		"Y", 
		"Z", 
		"a", 
		"b", 
		"c", 
		"d", 
		"e", 
		"f", 
		"g", 
		"h", 
		"i", 
		"j", 
		"k", 
		"l", 
		"m", 
		"n", 
		"o", 
		"p", 
		"q", 
		"r", 
		"s", 
		"t", 
		"u", 
		"v", 
		"w", 
		"x", 
		"y", 
		"z", 
		"0", 
		"1", 
		"2", 
		"3", 
		"4", 
		"5", 
		"6", 
		"7", 
		"8", 
		"9", 
		"!", 
		"?", 
		" ", 
		"\"", 
		"\'", 
		",", 
		".", 
		":", 
		";", 
		"--", 
		"/", 
		"(", 
		")", 
		"$", 
		"<", 
		">", 
		"%%", 
		"[", 
		"]", 
		"YEN", 
		"@Cruz", 
		"#", 
		"_", 
		"|", 
		"^", 
		"Âº", 
		"-", 
		"+", 
		"="
	};
	
	const char shash[] = {
		0x0C, 0x00, 0x00, 0x00,
		0x01, 0x00, 0x00, 0x00,
		0x40, 0x02, 0x00, 0x00,
		0x40, 0x03, 0x00, 0x00,
		0x40, 0x04, 0x00, 0x00,
		0x40, 0x05, 0x00, 0x01,
		0x40, 0x05, 0x00, 0x02,
		0x40, 0x05, 0x00, 0x03,
		0x40, 0x05, 0x00, 0x04,
		0x40, 0x05, 0x00, 0x05,
		0x40, 0x05, 0x00, 0x06,
		0x40, 0x05, 0x00, 0x07,
		0x40, 0x05, 0x00, 0x08,
		0x40, 0x06, 0x00, 0x00,
		0x40, 0x07, 0x00, 0x00,
		0x40, 0x2B, 0x00, 0x00,
		0x40, 0x2C, 0x00, 0x00,
		0x40, 0x2D, 0x00, 0x00,
		0x40, 0x11, 0x00, 0x00,
		0x40, 0x12, 0x00, 0x00,
		0x4D, 0x42, 0x44, 0x00,
		0x40, 0x10, 0x00, 0x00,
		0x40, 0x05, 0x01, 0x01,
		0x40, 0x36, 0x00, 0x00,
		0x80, 0x00, 0x00, 0x00,
		0x80, 0x00, 0x01, 0x00,
		0x80, 0x00, 0x02, 0x00,
		0x80, 0x00, 0x03, 0x00,
		0x80, 0x00, 0x04, 0x00,
		0x80, 0x00, 0x05, 0x00,
		0x80, 0x00, 0x06, 0x00,
		0x80, 0x00, 0x07, 0x00,
		0x80, 0x00, 0x08, 0x00,
		0x80, 0x00, 0x09, 0x00,
		0x80, 0x00, 0x0A, 0x00,
		0x80, 0x00, 0x0B, 0x00,
		0x80, 0x00, 0x0C, 0x00,
		0x80, 0x00, 0x0D, 0x00,
		0x80, 0x00, 0x0E, 0x00,
		0x80, 0x00, 0x0F, 0x00,
		0x80, 0x00, 0x10, 0x00,
		0x80, 0x00, 0x11, 0x00,
		0x80, 0x00, 0x12, 0x00,
		0x80, 0x00, 0x13, 0x00,
		0x80, 0x00, 0x14, 0x00,
		0x80, 0x00, 0x15, 0x00,
		0x80, 0x00, 0x16, 0x00,
		0x80, 0x00, 0x17, 0x00,
		0x80, 0x00, 0x18, 0x00,
		0x80, 0x00, 0x19, 0x00,
		0x80, 0x00, 0x1A, 0x00,
		0x80, 0x00, 0x1B, 0x00,
		0x80, 0x00, 0x1C, 0x00,
		0x80, 0x00, 0x1D, 0x00,
		0x80, 0x00, 0x1E, 0x00,
		0x80, 0x00, 0x1F, 0x00,
		0x80, 0x00, 0x20, 0x00,
		0x80, 0x00, 0x21, 0x00,
		0x80, 0x00, 0x22, 0x00,
		0x80, 0x00, 0x23, 0x00,
		0x80, 0x00, 0x24, 0x00,
		0x80, 0x00, 0x25, 0x00,
		0x80, 0x00, 0x26, 0x00,
		0x80, 0x00, 0x27, 0x00,
		0x80, 0x00, 0x28, 0x00,
		0x80, 0x00, 0x29, 0x00,
		0x80, 0x00, 0x2A, 0x00,
		0x80, 0x00, 0x2B, 0x00,
		0x80, 0x00, 0x2C, 0x00,
		0x80, 0x00, 0x2D, 0x00,
		0x80, 0x00, 0x2E, 0x00,
		0x80, 0x00, 0x2F, 0x00,
		0x80, 0x00, 0x30, 0x00,
		0x80, 0x00, 0x31, 0x00,
		0x80, 0x00, 0x32, 0x00,
		0x80, 0x00, 0x33, 0x00,
		0x80, 0x00, 0x34, 0x00,
		0x80, 0x00, 0x35, 0x00,
		0x80, 0x00, 0x36, 0x00,
		0x80, 0x00, 0x37, 0x00,
		0x80, 0x00, 0x38, 0x00,
		0x80, 0x00, 0x39, 0x00,
		0x80, 0x00, 0x3A, 0x00,
		0x80, 0x00, 0x3B, 0x00,
		0x80, 0x00, 0x3C, 0x00,
		0x80, 0x00, 0x3D, 0x00,
		0x80, 0x00, 0x3E, 0x00,
		0x80, 0x00, 0x3F, 0x00,
		0x80, 0x00, 0x40, 0x00,
		0x80, 0x00, 0x41, 0x00,
		0x80, 0x00, 0x42, 0x00,
		0x80, 0x00, 0x43, 0x00,
		0x80, 0x00, 0x44, 0x00,
		0x80, 0x00, 0x45, 0x00,
		0x80, 0x00, 0x46, 0x00,
		0x80, 0x00, 0x47, 0x00,
		0x80, 0x00, 0x48, 0x00,
		0x80, 0x00, 0x49, 0x00,
		0x80, 0x00, 0x4A, 0x00,
		0x80, 0x00, 0x4B, 0x00,
		0x80, 0x00, 0x4C, 0x00,
		0x80, 0x00, 0x4D, 0x00,
		0x80, 0x00, 0x4E, 0x00,
		0x80, 0x00, 0x4F, 0x00,
		0x80, 0x00, 0x50, 0x00,
		0x80, 0x00, 0x51, 0x00,
		0x80, 0x00, 0x52, 0x00,
		0x80, 0x00, 0x53, 0x00,
		0x80, 0x00, 0x54, 0x00,
		0x80, 0x00, 0x55, 0x00,
		0x80, 0x00, 0x56, 0x00,
		0x80, 0x00, 0x57, 0x00,
		0x80, 0x00, 0x58, 0x00,
		0x80, 0x00, 0x59, 0x00,
		0x80, 0x00, 0x5A, 0x00
	};

	if (argc < 2) {
		printUsage(argv[0]);
		return 0;
	}

	ifp = fopen(argv[1], mode);
	if (!ifp) {
		fprintf(stderr, "Unable to open %s: %s\n", 
				argv[1], strerror(errno));
		return errno;
	}

	fseek(ifp, 0 * sizeof(char), SEEK_END);
	ifp_len = ftell(ifp);
	rewind(ifp);

	fbuff = (char *)malloc(ifp_len + 1 * sizeof(char));
	if (!fbuff) {
		fprintf(stderr, "Unable to allocate memory: %s\n", 
				strerror(errno));
		fclose(ifp);
		return errno;
	}

	fread(fbuff, ifp_len, 1 * sizeof(char), ifp);
	fclose(ifp);

	mbdp = memmem(fbuff, ifp_len, magicnum, 4 * sizeof(char));
	if (!mbdp) {
		fprintf(stderr, "Cannot find MBD header.\n");
		return 1;
	}

	offset = (int)(mbdp - fbuff);

	for (i = offset * sizeof(char); i < ifp_len; i += 4 * sizeof(char)) {
		memcpy(tmp, &fbuff[i], 8 * sizeof(char));
		p = memmem(lhash, 256 * 8 * sizeof(char), tmp, 8 * sizeof(char));
		if (p) {
			i += 8 * sizeof(char);
			printf("%s", ldict[(int)(p - lhash) / 8 * sizeof(char)]);
		}
		
		memcpy(tmp, &fbuff[i], 4 * sizeof(char));
		p = memmem(shash, 115 * 4 * sizeof(char), tmp, 4 * sizeof(char));
		if (p) {
			printf("%s", sdict[(int)(p - shash) / 4 * sizeof(char)]);
		}
	}

	printf("\n");

	free(fbuff);

	return 0;
}
